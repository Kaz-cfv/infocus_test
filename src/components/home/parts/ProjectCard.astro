---
interface Tag {
  name: string;
  url: string;
}

interface Props {
  id: number;
  title: string;
  tags: Tag[];
  imageSrc: string;
  videoSrc?: string;
  imageAlt?: string;
  url?: string;
  type?: string;
}

const {
  id = '',
  title,
  tags,
  imageSrc,
  videoSrc,
  imageAlt = "Projects Image",
  url,
  type = "",
} = Astro.props;

// urlãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ãã®ä¸­èº«ã‚’ç¢ºèªã—ã€æ–‡å­—åˆ—ã¨ã—ã¦å–å¾—
let safeUrl = '#';
let linkTarget = null;

if (typeof url === 'string' && url) {
  safeUrl = url;
} else if (url && typeof url === 'object') {
  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã€href/url ã¨targetæƒ…å ±ã‚’å–å¾—
  if ('href' in url) {
    safeUrl = url.href;
  } else if ('url' in url) {
    safeUrl = url.url;
  }

  // targetæƒ…å ±ãŒã‚ã‚Œã°å–å¾—
  if ('target' in url) {
    linkTarget = url.target;
  }
}

// å¤–éƒ¨ãƒªãƒ³ã‚¯ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆhttp/httpsã§å§‹ã¾ã‚Šã€ã‹ã¤ç¾åœ¨ã®ã‚µã‚¤ãƒˆã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ãªã„å ´åˆï¼‰
const isExternalLink = (safeUrl.startsWith('http://') || safeUrl.startsWith('https://')) &&
                      !safeUrl.startsWith(Astro.site?.href || '');

// linkTargetãŒ'_blank'ã®å ´åˆã‚‚å¤–éƒ¨ãƒªãƒ³ã‚¯ã¨ã—ã¦æ‰±ã†
const shouldOpenInNewTab = isExternalLink || linkTarget === '_blank';

const linkProps = shouldOpenInNewTab
  ? { href: safeUrl, target: '_blank', rel: 'noopener noreferrer' }
  : { href: safeUrl };

// ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆå•é¡Œè§£æ±ºå¾Œã«å‰Šé™¤äºˆå®šï¼‰
// console.log('ğŸ” ProjectCard URL Debug:', {
//   originalUrl: url,
//   urlType: typeof url,
//   safeUrl: safeUrl,
//   isExternalLink: isExternalLink
// });
---

<div class="c-project-card mouse-over" data-id={id} data-type={type}>
  <a {...linkProps} class="c-project-card__image-wrapper">
    {imageSrc && (
      <img src={imageSrc} alt={imageAlt} class="c-project-card__image" />
    )}
    {videoSrc && (
      <video
        src={videoSrc}
        class="c-project-card__video"
        muted
        loop
        playsinline
        preload="metadata"
      ></video>
    )}
  </a>
  <div class="c-project-card__content">
    <h3 class="c-project-card__title">
      <a href={url}>{title}</a>
    </h3>
    <div class="c-project-card__tags js-hover">
      {tags.map((tag, index) => (
        <>
          <a href={tag.url} class="c-project-card__category js-hover-item">{tag.name}</a>
          {index < tags.length - 1 && <span class="c-project-card__separator">,</span>}
        </>
      ))}
    </div>
  </div>
</div>

<style lang="scss">
@use '../../../assets/scss/_mediaquery' as me;
@use '../../../assets/scss/_mixin' as mi;

.c-project-card {
  display: flex;
  flex-direction: column;
  position: relative;
  transition: opacity 0.3s ease-out;
  height: 100%;

  @include me.pc {
    &.mouse-over {
      &:hover {
        .c-project-card__image-wrapper {
          // å„è¾ºã‹ã‚‰10pxå†…å´ã«ã‚¯ãƒªãƒƒãƒ—ï¼ˆ360px â†’ 340pxç›¸å½“ï¼‰
          clip-path: inset(3px);
        }

        .c-project-card__image,
        .c-project-card__video {
          // ç”»åƒè‡ªä½“ã‚’æ‹¡å¤§ï¼ˆ360px â†’ 368pxç›¸å½“ï¼‰
          transform: scale(1.0222); // 368/360 = 1.0222
        }
      }
    }
  }

  &[data-type="cover"] {
    height: 100%;
  }

  &:not([data-type="cover"]) {
    @include me.pc {
      padding-bottom: 40px;
    }
    @include me.sp {
      padding-bottom: 7.701vw;
    }
    &[data-type="pickup"] {
      @include me.pc {
        padding-bottom: 40px;
      }
      @include me.sp {
        padding-bottom: 25px;
      }
    }
  }

  &__image-wrapper {
    display: block;
    position: relative;
    overflow: hidden;
    aspect-ratio: 16 / 9;
    clip-path: inset(0px);
    transition: clip-path 0.3s cubic-bezier(0, 0, 0.17, 1);
    @at-root [data-type="pickup"] & {
      @include me.pc {
        margin-top: 30px;
        margin-inline: 30px;
      }
    }
    @at-root [data-type="cover"] & {
      aspect-ratio: 1 / 1;
      @include me.pc {
        flex: 1;
      }
      @include me.sp {
        height: 100%;
        min-height: 100%;
        width: 100%;
      }
    }
  }

  &__image {
    @include mi.absolute-all;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s cubic-bezier(0, 0, 0.17, 1);
    @include me.sp {
      aspect-ratio: 16 / 9;
    }
  }

  &__video {
    @include mi.absolute-all;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s cubic-bezier(0, 0, 0.17, 1);
    z-index: 2;
    @at-root .c-project-card.is-play & {
      opacity: 1;
      visibility: visible;
    }
  }

  &__content {
    display: flex;
    flex-direction: column;
    row-gap: 8px;
    margin-top: 16px;
    padding-inline: 30px;
    @include me.sp {
      row-gap: 0;
      margin-top: 8px;
      padding-inline: 16px;
    }
    @at-root [data-type="cover"] & {
      display: none;
    }
  }

  &__title {
    a {
      color: var(--c-white);
      font-size: 1.6rem;
      font-weight: 700;
      line-height: 2.32rem;
      @include me.sp {
        font-size: 1.4rem;
      }
      @at-root [data-type="pickup"] & {
        font-size: 2rem;
        @include me.sp {
          font-size: 1.8rem;
        }
      }
    }
  }

  &__tags {
    font-size: 1.2rem;
    font-weight: 600;
    line-height: 2.32rem;
    @at-root [data-type="pickup"] & {
      font-size: 1.4rem;
      @include me.sp {
        font-size: 1.2rem;
      }
    }
  }

  &__category {
    display: inline-block;
    color: var(--c-gray);
  }

  &__separator {
    color: var(--c-gray);
    margin-inline-end: 4px;
  }
}
</style>
