---
// Props型定義
interface ProjectTag {
  name: string;
  url?: string;
  slug?: string;
}

interface ProjectData {
  cardType: 'post' | 'image' | 'movie';
  id: number;
  url: string;
  title: string;
  imageSrc: string;
  videoSrc: string;
  tags: ProjectTag[];
  type?: string;
  isMobile: boolean;
  language: string;
  acf_fc_layout?: string;
  post?: any;
  image?: any;
  file?: string;
  link?: {
    url: string;
  };
  is_mobile?: boolean;
}

interface Props {
  data?: ProjectData[];
  lang?: 'en' | 'ja';
}

const { data = [], lang = 'ja' } = Astro.props;
const currentUrl = lang === 'en' ? '/en/' : '/';

/**
 * 言語に応じたプロジェクトURLを生成
 */
function getLocalizedProjectURL(slug: string, language: string): string {
  if (language === 'en') {
    return `/en/projects/${slug}`;
  } else {
    return `/projects/${slug}`;
  }
}

/**
 * 言語に応じたタグフィルターURLを生成
 */
function getLocalizedTagURL(tagSlug: string, language: string): string {
  if (language === 'en') {
    return `/en/projects/?category=${tagSlug}`;
  } else {
    return `/projects/?category=${tagSlug}`;
  }
}

/**
 * プロジェクトデータを整形（ビルド時処理）
 */
const projectsData = data.map((pickupItem, index) => {
  let mappedData: any = {
    cardType: pickupItem.acf_fc_layout || 'unknown',
    id: 0,
    url: '#',
    title: '',
    imageSrc: '',
    videoSrc: '',
    tags: [],
    isMobile: pickupItem.is_mobile !== false,
    language: lang
  };

  if (pickupItem.acf_fc_layout === 'post') {
    // post タイプの処理
    const post = pickupItem.post || {};
    const acfs = post.acfs || {};

    // タグ情報の処理（言語対応版） -> 中身はカテゴリ
    const tags: ProjectTag[] = [];
    if (acfs.category && Array.isArray(acfs.category)) {
      acfs.category.forEach((categoryItem: any) => {
        if (categoryItem.name) {
          tags.push({
            name: categoryItem.name,
            url: getLocalizedTagURL(categoryItem.slug || '', lang)
          });
        }
      });
    }

    mappedData = {
      cardType: 'post',
      id: post.ID || 0,
      url: getLocalizedProjectURL(post.post_name || '', lang),
      title: post.post_title || '',
      imageSrc: post.acfs?.main?.image?.url || '',
      videoSrc: '',
      tags: tags,
      isMobile: pickupItem.is_mobile !== false,
      language: lang
    };

  } else if (pickupItem.acf_fc_layout === 'image') {
    // image タイプの処理
    mappedData = {
      cardType: 'image',
      id: pickupItem.image?.ID || 0,
      url: pickupItem.link?.url || '#',
      title: pickupItem.image?.title || '',
      imageSrc: pickupItem.image?.url || '',
      videoSrc: '',
      tags: [],
      type: 'cover',
      isMobile: pickupItem.is_mobile !== false,
      language: lang
    };

  } else if (pickupItem.acf_fc_layout === 'movie') {
    // movie タイプの処理
    mappedData = {
      cardType: 'movie',
      id: pickupItem.image?.ID || 0,
      url: pickupItem.link?.url || '#',
      title: pickupItem.image?.title || '',
      imageSrc: '',
      videoSrc: pickupItem.file || '',
      tags: [],
      type: 'cover',
      isMobile: pickupItem.is_mobile !== false,
      language: lang
    };
  }

  return mappedData;
});
---

<section class="p-home-projects">
  <ul class="p-home-projects__list" id="projectsList" data-language={lang}>
    {projectsData.map((project) => {
      const mobileClass = project.isMobile ? '' : 'sp-hidden';
      return (
        <li class={`p-home-projects__card ${mobileClass}`} data-language={project.language}>
          <div class="c-project-card mouse-over" data-id={project.id} data-type={project.type || project.cardType}>
            <a href={project.url} class="c-project-card__image-wrapper">
              {project.videoSrc ? (
                <video
                  src={project.videoSrc}
                  class="c-project-card__video"
                  muted
                  loop
                  playsinline
                  preload="metadata"
                />
              ) : (
                <img
                  src={project.imageSrc}
                  alt={project.title}
                  class="c-project-card__image"
                />
              )}
            </a>
            <div class="c-project-card__content">
              <h3 class="c-project-card__title">
                <a href={project.url}>{project.title}</a>
              </h3>
              <div class="c-project-card__tags js-hover">
                {project.tags.map((tag, index) => (
                  <>
                    <a href={tag.url} class="c-project-card__category js-hover-item">
                      {tag.name}
                    </a>
                    {index < project.tags.length - 1 && (
                      <span class="c-project-card__separator js-hover-item">,</span>
                    )}
                  </>
                ))}
              </div>
            </div>
          </div>
        </li>
      );
    })}
  </ul>
  <div class="p-home-projects__link">
    <a href={`${currentUrl}projects/`}>
      ALL PROJECTS
      <span><svg width="32" height="33" viewBox="0 0 32 33" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 14.1601L23.7876 14.1601C20.713 11.3362 15.4539 6.21272 12.177 3.02567L15.2111 0L32 16.4193V16.5L15.2111 33L12.177 29.813C15.4539 26.6663 20.713 21.5024 23.7876 18.6785H0L0 14.1601Z" fill="white"/></svg></span>
    </a>
  </div>
</section>

<script>
  import { VideoScrollController } from '../../../assets/js/modules/VideoScrollController';

  // VideoScrollControllerのインスタンスを保持
  let videoController: VideoScrollController | null = null;

  /**
   * VideoScrollControllerの初期化
   */
  function initializeVideoController() {
    try {
      // 既存のインスタンスがあれば破棄
      if (videoController && typeof videoController.destroy === 'function') {
        videoController.destroy();
      }

      // 新しいVideoScrollControllerインスタンスを作成
      videoController = new VideoScrollController();
      // console.log('✅ VideoScrollController initialized');
    } catch (error) {
      console.error('❌ VideoScrollController initialization failed:', error);
    }
  }

  /**
   * NavigationHoverの初期化
   */
  function initializeNavigationHover() {
    const projectsList = document.getElementById('projectsList');
    if (!projectsList) return;

    // NavigationHoverの再初期化イベントを発火
    const hoverEvent = new CustomEvent('reinitializeHover', {
      detail: { element: projectsList }
    });
    document.dispatchEvent(hoverEvent);

    // グローバルなNavigationHoverインスタンスが存在する場合、直接初期化
    if (window.navigationHover && typeof window.navigationHover.initializeInElement === 'function') {
      window.navigationHover.initializeInElement(projectsList);
    }

    // 手動でホバー処理を追加
    const hoverContainers = projectsList.querySelectorAll('.js-hover');
    hoverContainers.forEach((container) => {
      const items = container.querySelectorAll('.js-hover-item');
      items.forEach((item) => {
        item.addEventListener('mouseenter', (e) => {
          const hoveredItem = e.currentTarget as HTMLElement;
          hoveredItem.classList.add('is-hovered');

          items.forEach(siblingItem => {
            if (siblingItem !== hoveredItem) {
              (siblingItem as HTMLElement).classList.add('is-dimmed');
            }
          });
        });

        item.addEventListener('mouseleave', (e) => {
          const leftItem = e.currentTarget as HTMLElement;
          leftItem.classList.remove('is-hovered');

          items.forEach(siblingItem => {
            if (siblingItem !== leftItem) {
              (siblingItem as HTMLElement).classList.remove('is-dimmed');
            }
          });
        });
      });
    });

    // console.log('✅ NavigationHover initialized');
  }

  // DOMContentLoaded後に初期化
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      initializeVideoController();
      initializeNavigationHover();
    }, 100);
  });

  // ページがアンロードされる時にVideoControllerをクリーンアップ
  window.addEventListener('beforeunload', () => {
    if (videoController && typeof videoController.destroy === 'function') {
      videoController.destroy();
    }
  });
</script>

<style lang="scss" is:global>
@use '../../../assets/scss/mediaquery' as me;
@use '../../../assets/scss/mixin' as mi;

.p-home-projects {
  overflow: hidden;

  &__list {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    @include me.sp {
      grid-template-columns: 50% 50%;
    }
    &.--pickup {
      @include me.pc {
        grid-template-columns: 50% 50%;
      }
      @include me.sp {
        grid-template-columns: 100%;
      }
    }
  }

  &__card {
    border-right: solid 1px var(--c-gray02);
    border-bottom: solid 1px var(--c-gray02);
    // border-left: solid 1px var(--c-gray02);
    @include me.pc {
      &:first-child,
      &:nth-child(2) {
        border-top: none;
      }
      &:nth-child(4n+6) {
        border-right-color: transparent;
      }
    }
    @include me.sp {
      &:first-child,
      &:nth-child(2),
      &:nth-child(2n) {
        border-right: none;
      }
    }

    &:first-child {
      @include me.pc {
        grid-column: 1 / 3;
      }
      @include me.sp {
        grid-column: 1 / 3;
      }
    }
    &:nth-child(2) {
      @include me.pc {
        grid-column: 3 / 5;
      }
      @include me.sp {
        grid-column: 1 / 3;
      }
    }

    &.sp-hidden {
      @include me.sp {
        display: none;
      }
    }

    &:nth-child(4n) {
      @include me.pc {
        // border-right-color: transparent;
      }
    }
    &:nth-child(2n) {
      @include me.sp {
        // border-right-color: transparent;
      }
    }
  }

  &__link {
    border-top: solid 1px var(--c-white);

    a {
      display: flex;
      justify-content: center;
      align-items: center;
      column-gap: 27px;
      padding-block: 72px;
      color: var(--c-white);
      font-size: 5.2rem;
      font-weight: 700;
      @include me.sp {
        column-gap: 14px;
        padding-block: 35px;
        font-size: 2.6rem;
      }
    }

    span {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 32px;
      height: 33px;
      @include me.sp {
        width: 15px;
        height: 16px;
      }
    }
  }
}

.c-project-card {
  display: flex;
  flex-direction: column;
  position: relative;
  transition: opacity 0.3s ease-out;
  height: 100%;

  @include me.pc {
    &.mouse-over {
      &:hover {
        .c-project-card__image-wrapper {
          // 各辺から10px内側にクリップ（360px → 340px相当）
          clip-path: inset(7px);
        }

        .c-project-card__image,
        .c-project-card__video {
          // 画像自体を拡大（360px → 368px相当）
          // transform: scale(1.0222); // 368/360 = 1.0222
        }
      }
    }
  }

  &[data-type="cover"] {
    height: 100%;
  }

  &:not([data-type="cover"]) {
    @include me.pc {
      padding-bottom: 40px;
    }
    @include me.sp {
      padding-bottom: 7.701vw;
    }
    &[data-type="pickup"] {
      @include me.pc {
        padding-bottom: 50px;
      }
      @include me.sp {
        padding-bottom: 25px;
      }
    }
  }

  &__image-wrapper {
    display: block;
    position: relative;
    overflow: hidden;
    aspect-ratio: 16 / 9;
    clip-path: inset(0px);
    transition: clip-path .4s cubic-bezier(0.16, 1.02, 0.52, 1.03);
    @at-root [data-type="pickup"] & {
      @include me.pc {
        margin-top: 30px;
        margin-inline: 30px;
      }
    }
    @at-root [data-type="cover"] & {
      aspect-ratio: 1 / 1;
      @include me.pc {
        flex: 1;
      }
      @include me.sp {
        height: 100%;
        min-height: 100%;
        width: 100%;
      }
    }
  }

  &__image {
    @include mi.absolute-all;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s cubic-bezier(0, 0, 0.17, 1);
    @include me.sp {
      aspect-ratio: 16 / 9;
    }
  }

  &__video {
    @include mi.absolute-all;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s cubic-bezier(0, 0, 0.17, 1);
    z-index: 2;
    @at-root .c-project-card.is-play & {
      opacity: 1;
      visibility: visible;
    }
  }

  &__content {
    display: flex;
    flex-direction: column;
    row-gap: 8px;
    margin-top: 16px;
    padding-inline: 30px;
    @include me.sp {
      row-gap: 0;
      margin-top: 8px;
      padding-inline: 16px;
    }
    @at-root [data-type="cover"] & {
      display: none;
    }
  }

  &__title {
    a {
      color: var(--c-white);
      font-size: 1.6rem;
      font-weight: 700;
      line-height: 2.32rem;
      @include me.sp {
        font-size: 1.4rem;
      }
      @at-root [data-type="pickup"] & {
        font-size: 2rem;
        @include me.sp {
          font-size: 1.8rem;
        }
      }
    }
  }

  &__tags {
    font-size: 1.2rem;
    font-weight: 600;
    line-height: 2.32rem;
    @at-root [data-type="pickup"] & {
      font-size: 1.4rem;
      @include me.sp {
        font-size: 1.2rem;
      }
    }
  }

  &__category {
    display: inline-block;
    color: var(--c-gray);
  }

  &__separator {
    color: var(--c-gray);
    margin-inline-end: 4px;
  }
}
</style>
