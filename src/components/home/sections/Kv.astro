---
// Propså‹å®šç¾© - ç©ºã®Propsã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§å‹•çš„ã«è¨­å®š
export interface Props {}
---

<div class="p-home-kv" data-video id="kvContainer">
  <div class="p-home-kv__item">
    <video
      id="kvVideo"
      autoplay
      muted
      playsinline
      class="p-home-kv__video"
    >
    </video>
  </div>
</div>

<!-- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§APIãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹ -->
<script>
  // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã§APIãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹
  document.addEventListener('homeDataLoaded', (event) => {
    const homeData = (event as CustomEvent).detail;

    // ãƒ’ãƒ¼ãƒ­ãƒ¼å‹•ç”»ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
    let herosData = null;
    if (homeData?.heros) {
      herosData = homeData.heros;
    } else if (homeData?.home?.heros) {
      herosData = homeData.home.heros;
    }

    const videoElement = document.getElementById('kvVideo');
    if (!videoElement) {
      console.warn('âš ï¸ å‹•ç”»è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      return;
    }
    const video = videoElement as HTMLVideoElement;

    if (herosData && Array.isArray(herosData) && herosData.length > 0) {
      // å…¨å‹•ç”»ã®URLã‚’é…åˆ—ã«æ ¼ç´
      const videoUrls = herosData.map(hero => hero.movie).filter(url => url);
      let currentIndex = 0; // ã“ã“ã‚’0ã«å›ºå®š

      // ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ©ãƒ³ãƒ€ãƒ ãªé–‹å§‹ä½ç½®ã‚’è¨­å®š
      // **ã“ã®éƒ¨åˆ†ã‚’å‰Šé™¤**
      // const randomIndex = Math.floor(Math.random() * videoUrls.length);
      // currentIndex = randomIndex;

      // å‹•ç”»å†ç”Ÿã®é–¢æ•°
      const playNextVideo = () => {
        if (videoUrls.length === 0) return;
        const currentUrl = videoUrls[currentIndex];
        // console.log(`ğŸ¥ å†ç”Ÿå‹•ç”»: ${currentUrl}`);
        video.src = currentUrl;
        video.load();
        video.play();

        video.removeEventListener('ended', onVideoEnd);
        video.addEventListener('ended', onVideoEnd);
      };
      // å‹•ç”»çµ‚äº†æ™‚ã®å‡¦ç†
      const onVideoEnd = () => {
        currentIndex = (currentIndex + 1) % videoUrls.length;
        playNextVideo();
      };

      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      video.addEventListener('error', (e) => {
        console.error('âŒ å‹•ç”»ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã‚‚æ¬¡ã®å‹•ç”»ã¸
        onVideoEnd();
      });
      // æœ€åˆã®å‹•ç”»ã‚’å†ç”Ÿ
      playNextVideo();
    } else {
      console.warn('âš ï¸ å‹•ç”»ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
    }
  });
</script>

<style lang="scss">
@use '../../../assets/scss/mediaquery' as me;
@use '../../../assets/scss/mixin' as mi;

.p-home-kv {
  overflow: hidden;

  &__item {
    position: relative;
    @include me.pc {
      aspect-ratio: 1440 / 563;
      width: 100%;
    }
    @include me.sp {
      aspect-ratio: 4 / 5;
      width: 100%;
    }
  }

  &__video {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
}

</style>
