---
// Propså‹å®šç¾© - ç©ºã®Propsã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§å‹•çš„ã«è¨­å®š
export interface Props {}
---

<div class="p-home-kv" data-video id="kvContainer">
  <div class="p-home-kv__item">
    <video
      id="kvVideo"
      autoplay
      muted
      playsinline
      class="p-home-kv__video"
    >
    </video>
  </div>
</div>

<!-- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§APIãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹ -->
<script>
  // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã§APIãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹
  document.addEventListener('homeDataLoaded', (event) => {
    const homeData = (event as CustomEvent).detail;

    // ãƒ’ãƒ¼ãƒ­ãƒ¼å‹•ç”»ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
    let herosData = null;
    if (homeData?.heros) {
      herosData = homeData.heros;
    } else if (homeData?.home?.heros) {
      herosData = homeData.home.heros;
    }

    const videoElement = document.getElementById('kvVideo');
    if (!videoElement) {
      console.warn('âš ï¸ å‹•ç”»è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      return;
    }
    const video = videoElement as HTMLVideoElement;

    if (herosData && Array.isArray(herosData) && herosData.length > 0) {
      // ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®š
      const isSP = window.innerWidth <= 768;

      // ãƒ‡ãƒã‚¤ã‚¹ã«å¿œã˜ã¦é©åˆ‡ãªå‹•ç”»URLã‚’é¸æŠ
      const videoUrls = herosData.map(hero => {
        // SPç”¨ã®å‹•ç”»ãŒã‚ã‚‹å ´åˆã¯ãƒ‡ãƒã‚¤ã‚¹ã«å¿œã˜ã¦åˆ‡ã‚Šæ›¿ãˆ
        if (isSP && hero.movie_sp) {
          return hero.movie_sp;
        }
        // PCç”¨ã¾ãŸã¯SPç”¨å‹•ç”»ãŒãªã„å ´åˆã¯movieã‚’ä½¿ç”¨
        return hero.movie;
      }).filter(url => url);

      let currentIndex = 0;

      // å‹•ç”»å†ç”Ÿã®é–¢æ•°
      const playNextVideo = () => {
        if (videoUrls.length === 0) return;
        const currentUrl = videoUrls[currentIndex];
        // console.log(`ğŸ¥ å†ç”Ÿå‹•ç”»: ${currentUrl} (${isSP ? 'SP' : 'PC'})`);
        video.src = currentUrl;
        video.load();
        video.play();

        video.removeEventListener('ended', onVideoEnd);
        video.addEventListener('ended', onVideoEnd);
      };

      // å‹•ç”»çµ‚äº†æ™‚ã®å‡¦ç†
      const onVideoEnd = () => {
        currentIndex = (currentIndex + 1) % videoUrls.length;
        playNextVideo();
      };

      // ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‡¦ç†
      let resizeTimer: number;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = window.setTimeout(() => {
          const newIsSP = window.innerWidth <= 768;
          // ãƒ‡ãƒã‚¤ã‚¹ãŒå¤‰ã‚ã£ãŸå ´åˆ
          if (newIsSP !== isSP) {
            location.reload(); // ç°¡å˜ãªå®Ÿè£…ã¨ã—ã¦å†èª­ã¿è¾¼ã¿
          }
        }, 300);
      });

      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      video.addEventListener('error', (e) => {
        console.error('âŒ å‹•ç”»ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã‚‚æ¬¡ã®å‹•ç”»ã¸
        onVideoEnd();
      });

      // æœ€åˆã®å‹•ç”»ã‚’å†ç”Ÿ
      playNextVideo();
    } else {
      console.warn('âš ï¸ å‹•ç”»ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
    }
  });
</script>

<style lang="scss">
@use '../../../assets/scss/mediaquery' as me;
@use '../../../assets/scss/mixin' as mi;

.p-home-kv {
  overflow: hidden;
  position: relative;
  min-height: 660px;
  @include me.sp {
    min-height: 446.33px;
  }

  &__item {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    @include me.pc {
      // aspect-ratio: 1440 / 563;
    }
    @include me.sp {
      // aspect-ratio: 4 / 5;
    }
  }

  &__video {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
}

</style>
