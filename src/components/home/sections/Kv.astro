---
// Props型定義
export interface Hero {
  movie: string;
  movie_sp?: string;
  // 他のフィールドがあれば追加
}

export interface Props {
  heros: Hero[];
}

const { heros = [] } = Astro.props;
---

<div class="p-home-kv" data-kv>
  {heros.length > 0 ? (
    heros.map((hero, index) => (
      <div
        class={`p-home-kv__item ${index === 0 ? 'is-active' : ''}`}
        data-video-index={index}
      >
        <video
          class="p-home-kv__video p-home-kv__video--pc"
          autoplay={index === 0}
          muted
          playsinline
          loop={heros.length === 1}
          src={hero.movie}
          data-device="pc"
        />

        {hero.movie_sp && (
          <video
            class="p-home-kv__video p-home-kv__video--sp"
            autoplay={index === 0}
            muted
            playsinline
            loop={heros.length === 1}
            src={hero.movie_sp}
            data-device="sp"
          />
        )}
      </div>
    ))
  ) : (
    <div class="p-home-kv__item is-active">
      <p>動画データがありません</p>
    </div>
  )}
</div>

<script>
  class KvVideoManager {
    private container: HTMLElement | null;
    private items: NodeListOf<HTMLElement>;
    private currentIndex: number = 0;
    private totalVideos: number = 0;
    private currentVideo: HTMLVideoElement | null = null;

    constructor() {
      this.container = document.querySelector('[data-kv]');
      if (!this.container) return;

      this.items = this.container.querySelectorAll('.p-home-kv__item');
      this.totalVideos = this.items.length;

      // 1つしかない場合はループ再生なので切り替え不要
      if (this.totalVideos <= 1) return;

      this.init();
    }

    private init(): void {
      // 最初のアクティブな動画を取得
      const activeItem = this.container?.querySelector('.p-home-kv__item.is-active');
      if (activeItem) {
        this.currentVideo = this.getActiveVideo(activeItem as HTMLElement);
        if (this.currentVideo) {
          this.currentVideo.addEventListener('ended', this.onVideoEnd.bind(this));
        }
      }
    }

    private getActiveVideo(item: HTMLElement): HTMLVideoElement | null {
      // デバイス判定
      const isSP = window.innerWidth <= 768;
      const deviceClass = isSP ? 'p-home-kv__video--sp' : 'p-home-kv__video--pc';

      // デバイスに応じた動画を取得
      const video = item.querySelector(`.${deviceClass}`) as HTMLVideoElement;

      // SP用がない場合はPC用にフォールバック
      if (!video && isSP) {
        return item.querySelector('.p-home-kv__video--pc') as HTMLVideoElement;
      }

      return video;
    }

    private onVideoEnd(): void {
      // 次のインデックスを計算
      const nextIndex = (this.currentIndex + 1) % this.totalVideos;

      // 現在のアイテムから is-active を削除
      this.items[this.currentIndex].classList.remove('is-active');

      // 次のアイテムに is-active を追加
      this.items[nextIndex].classList.add('is-active');

      // 次の動画を取得して再生
      const nextVideo = this.getActiveVideo(this.items[nextIndex]);
      if (nextVideo) {
        nextVideo.play();
        // イベントリスナーを付け替え
        if (this.currentVideo) {
          this.currentVideo.removeEventListener('ended', this.onVideoEnd.bind(this));
        }
        this.currentVideo = nextVideo;
        this.currentVideo.addEventListener('ended', this.onVideoEnd.bind(this));
      }

      this.currentIndex = nextIndex;
    }
  }

  // ページ読み込み時に初期化
  document.addEventListener('DOMContentLoaded', () => {
    new KvVideoManager();
  });
</script>

<style lang="scss">
@use '../../../assets/scss/mediaquery' as me;
@use '../../../assets/scss/mixin' as mi;

.p-home-kv {
  overflow: hidden;
  position: relative;
  min-height: 660px;
  @include me.sp {
    min-height: 446.33px;
  }

  &__item {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.6s ease;

    &.is-active {
      opacity: 1;
      pointer-events: auto;
    }
  }

  &__video {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;

    &--pc {
      @include me.sp {
        display: none;
      }
    }

    &--sp {
      @include me.pc {
        display: none;
      }
    }
  }
}
</style>
