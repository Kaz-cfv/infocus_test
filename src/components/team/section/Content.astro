---
import TeamCard from '../parts/TeamCard.astro';

---

<div class="p-team-content" data-main-content>
  <ul class="p-team-content__list" id="teamList">
    <!-- ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã¨å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
  </ul>

  <!-- SPæ™‚ã®2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ -->
  <div class="p-team-content__columns" style="display: none;">
    <div class="p-team-content__column" data-column="left"></div>
    <div class="p-team-content__column" data-column="right"></div>
  </div>
</div>

<style lang="scss" is:global>
@use '../../../assets/scss/mediaquery' as me;
@use '../../../assets/scss/mixin' as mi;

.p-team-content {
  margin-block-start: 90px;
  padding-inline: 30px;
  padding-block-end: 107px;
  @include me.sp {
    margin-block-start: 60px;
    padding-inline: 20px;
    padding-block-end: 80px;
  }

  &__list {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    column-gap: 25px;
    row-gap: 50px;
    @include me.sp {
      display: none;
    }
  }

  &__columns {
    display: none;
    @include me.sp {
      display: flex;
      column-gap: 20px;
      align-items: flex-start;
    }
  }

  &__column {
    flex: 1;
    display: flex;
    flex-direction: column;
    row-gap: 50px;
  }
}

.c-team-card {
  display: grid;
  grid-template-columns: 100%;
  align-content: flex-start;
  row-gap: 18px;

  &__thumb {
    display: block;
  }

  &__info {
    display: grid;
    grid-template-columns: 100%;
    align-content: flex-start;
    row-gap: 22px;
    @include me.sp {
      row-gap: 12px;
    }
  }

  &__name {
    font-size: 1.8rem;
    font-weight: 600;
    line-height: 0.78;
    letter-spacing: .02rem;
  }

  &__tags {
    display: flex;
    flex-wrap: wrap;
    column-gap: 4px;
    row-gap: 8px;

    &-item {
      display: flex;
      align-items: center;
      column-gap: 4px;
      color: var(--c-gray);
      font-size: 1.2rem;
      font-weight: 700;
      line-height: 0.80;
      &::after {
        content: "/";
        display: inline-block;
      }
      &:last-child {
        &::after {
          display: none;
        }
      }

      a {
        color: var(--c-gray);
        font-size: 1.2rem;
        font-weight: 700;
        line-height: 0.80;
      }
    }
  }
}
</style>

<script>
class TeamLayoutManager {
  constructor() {
    this.teamData = [];
    this.init();
  }

  init() {
    // APIãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡å¾…ã¡
    document.addEventListener('teamDataLoaded', (event) => {
      this.handleTeamData(event.detail);
    });

    if (window.innerWidth <= 768) {
      this.setupMobileLayout();
    }

    window.addEventListener('resize', () => {
      if (window.innerWidth <= 768) {
        this.setupMobileLayout();
      } else {
        this.setupDesktopLayout();
      }
    });
  }

  /**
   * APIã‹ã‚‰å–å¾—ã—ãŸãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
   */
  handleTeamData(teamData) {
    // console.log('ğŸ‘¥ Content.astro: ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡:', teamData);

    this.teamData = teamData;
    this.renderTeamCards();
  }

  /**
   * ãƒãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚’å‹•çš„ã«ç”Ÿæˆãƒ»è¡¨ç¤º
   */
  renderTeamCards() {
    const teamList = document.getElementById('teamList');
    if (!teamList) return;

    // æ—¢å­˜ã®è¦ç´ ã‚’ã‚¯ãƒªã‚¢
    teamList.innerHTML = '';

    // ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦è¡¨ç¤º
    this.teamData.forEach((member) => {
      const listItem = this.createTeamListItem(member);
      teamList.appendChild(listItem);
    });

    // ã‚«ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã«é€šçŸ¥
    const event = new CustomEvent('teamCardsRendered');
    document.dispatchEvent(event);

    // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å†é©ç”¨
    if (window.innerWidth <= 768) {
      this.setupMobileLayout();
    }
  }

  /**
  * å€‹åˆ¥ã®ãƒãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
  */
  createTeamListItem(member) {
  const li = document.createElement('li');
  li.className = 'p-team-content__list-item';
  li.setAttribute('data-item', member.id);

  // ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚¹ãƒ©ãƒƒã‚°ã®å–å¾—ï¼ˆtaxonomy.positionã‹ã‚‰ï¼‰
  const positions = member.taxonomy?.position || [];
  const positionSlugs = positions.map(pos => pos.slug || '').filter(slug => slug);
  li.setAttribute('data-positions', positionSlugs.join(','));

  // ãƒãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã®HTMLç”Ÿæˆ
  const teamCard = this.createTeamCardHTML(member);
  li.innerHTML = teamCard;

  return li;
  }

  /**
   * ãƒãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã®HTMLã‚’ç”Ÿæˆ
   */
  createTeamCardHTML(member) {
    const name = member.title || 'No Name';
    const pic = member.acfs?.thumbnail?.url || '';
    const slug = member.slug || '#';
    const url = slug !== '#' ? `/team/${slug}` : '#';

    // ã‚¿ã‚°æƒ…å ±ã®å‡¦ç†
    const tags = this.processTeamTags(member);
    const tagsHTML = tags.map(tag => {
      // å…¨ã¦ã®ã‚¿ã‚°ã‚’aã‚¿ã‚°ã§ãƒ©ãƒƒãƒ—ã—ã€positionãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ãƒªãƒ³ã‚¯ã‚’è¨­å®š
      const filterUrl = tag.slug ? `/team/?position=${tag.slug}` : '/team/';
      return `<li class="c-team-card__tags-item js-hover-item"><a href="${filterUrl}">${tag.name}</a></li>`;
    }).join('');

    return `
      <div class="c-team-card">
        <a href="${url}" class="c-team-card__thumb">
          <img src="${pic}" alt="${name}">
        </a>
        <div class="c-team-card__info">
          <h3 class="c-team-card__name">${name}</h3>
          <ul class="c-team-card__tags js-hover">
            ${tagsHTML}
          </ul>
        </div>
      </div>
    `;
  }

  /**
   * ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¿ã‚°æƒ…å ±ã‚’å‡¦ç†
   */
  processTeamTags(member) {
    const tags = [];

    // ãƒã‚¸ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’taxonomy.positionã‹ã‚‰å–å¾—
    const positions = member.taxonomy?.position || [];
    positions.forEach(position => {
      if (position.name) {
        tags.push({
          name: position.name,
          slug: position.slug,
          url: '#',
          isPosition: true
        });
      }
    });

    // ãã®ä»–ã®ã‚¿ã‚°ãŒå¿…è¦ãªå ´åˆã¯ã“ã“ã§è¿½åŠ 
    // ä¾‹ï¼šã‚¹ã‚­ãƒ«ã€å°‚é–€åˆ†é‡ãªã©

    return tags;
  }

  setupMobileLayout() {
    const list = document.querySelector('.p-team-content__list');
    const columns = document.querySelector('.p-team-content__columns');
    const leftColumn = document.querySelector('[data-column="left"]');
    const rightColumn = document.querySelector('[data-column="right"]');

    if (!list || !columns) return;

    // ãƒªã‚¹ãƒˆã‚’éè¡¨ç¤ºã«ã—ã€ã‚«ãƒ©ãƒ ã‚’è¡¨ç¤º
    list.style.display = 'none';
    columns.style.display = 'flex';

    // ã‚«ãƒ©ãƒ ã‚’ã‚¯ãƒªã‚¢
    leftColumn.innerHTML = '';
    rightColumn.innerHTML = '';

    // ã‚¢ã‚¤ãƒ†ãƒ ã‚’å·¦å³ã«æŒ¯ã‚Šåˆ†ã‘
    const items = list.querySelectorAll('.p-team-content__list-item');
    items.forEach((item, index) => {
      const clonedItem = item.cloneNode(true);
      if (index % 2 === 0) {
        leftColumn.appendChild(clonedItem);
      } else {
        rightColumn.appendChild(clonedItem);
      }
    });
  }

  setupDesktopLayout() {
    const list = document.querySelector('.p-team-content__list');
    const columns = document.querySelector('.p-team-content__columns');

    if (!list || !columns) return;

    list.style.display = 'grid';
    columns.style.display = 'none';
  }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
if (typeof window !== 'undefined') {
  document.addEventListener('DOMContentLoaded', () => {
    new TeamLayoutManager();
  });
}
</script>
