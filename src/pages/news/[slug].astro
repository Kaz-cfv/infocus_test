---
import Layout from '../../layouts/Layout.astro';
import Article from '../../components/news-detail/section/Article.astro';
import Related from '../../components/news-detail/section/Related.astro';

export async function getStaticPaths() {
  try {
    // ãƒ‹ãƒ¥ãƒ¼ã‚¹APIã‹ã‚‰ç›´æ¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    let newsData = [];

    try {
      console.log('ğŸ“¡ ãƒ‹ãƒ¥ãƒ¼ã‚¹APIï¼ˆæ—¥æœ¬èªï¼‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
      const newsResponse = await fetch('https://infocus.wp.site-prev2.com/wp-json/wp/v2/news?lang=ja&_embed', {
        headers: {
          'User-Agent': 'Astro-Build/1.0.0',
          'Accept': 'application/json',
          'Cache-Control': 'no-cache'
        }
      });

      if (newsResponse.ok) {
        const wpNews = await newsResponse.json();
        console.log(`âœ… ${wpNews.length}ä»¶ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾—`);

        // ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆçš„ã«å‡¦ç†
        const processedNews = wpNews.map((item, index) => {
          const formatDate = (dateString) => {
            try {
              const date = new Date(dateString);
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              return `${year}.${month}.${day}`;
            } catch (error) {
              console.warn('âš ï¸ æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', dateString);
              return '----.--.--';
            }
          };

          const getThumbnail = (item) => {
            if (item.acfs?.news_mv?.url) {
              return item.acfs.news_mv.url;
            }
            if (item.acfs?.news_mv?.sizes?.large) {
              return item.acfs.news_mv.sizes.large;
            }
            if (item.featured_media && item._embedded?.['wp:featuredmedia']?.[0]?.source_url) {
              return item._embedded['wp:featuredmedia'][0].source_url;
            }
            return '/common/images/news/default.png';
          };

          const slug = item.slug;

          // ã‚¿ã‚¤ãƒˆãƒ«ã®æ§˜ã€…ãªå½¢å¼ã«å¯¾å¿œ
          let title = 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—';
          if (typeof item.title === 'string') {
            title = item.title;
          } else if (item.title?.rendered) {
            title = item.title.rendered;
          } else if (item.title_plain) {
            title = item.title_plain;
          } else if (item.acfs?.news_title) {
            title = item.acfs.news_title;
          }

          console.log(`ğŸ” ãƒ‹ãƒ¥ãƒ¼ã‚¹${index + 1}: ID=${item.id}, slug="${slug}"`);
          console.log(`   ã‚¿ã‚¤ãƒˆãƒ«å–å¾—çµæœ: "${title}"`);
          console.log(`   å…ƒãƒ‡ãƒ¼ã‚¿æ§‹é€ : ${typeof item.title}, rendered: ${item.title?.rendered}`);

          return {
            id: item.id,
            slug: slug,
            title: title,
            date: formatDate(item.date),
            category: item.type?.toUpperCase() || 'NEWS',
            pic: getThumbnail(item),
            acfs: item.acfs || {},
            content: item.content?.rendered || '',
            link: item.link || '',
            article: item.acfs?.news_article || '',
            excerpt: item.excerpt?.rendered || '',
            // ãƒ‹ãƒ¥ãƒ¼ã‚¹å›ºæœ‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            tags: item.acfs?.news_tags || [],
            author: item.acfs?.news_author || '',
            wordpressId: item.id,
            lastModified: item.modified || item.date,
            sourceType: 'news'
          };
        });

        newsData.push(...processedNews);

      } else {
        console.log('âš ï¸ ãƒ‹ãƒ¥ãƒ¼ã‚¹APIï¼ˆæ—¥æœ¬èªï¼‰ãŒåˆ©ç”¨ä¸å¯');
      }
    } catch (newsError) {
      console.log('â„¹ï¸ ãƒ‹ãƒ¥ãƒ¼ã‚¹APIæ¥ç¶šã‚¨ãƒ©ãƒ¼:', newsError.message);
    }


    const staticPaths = newsData.map((news) => ({
      params: { slug: news.slug },
      props: { news }
    }));

    console.log('ğŸ›¤ï¸ ç”Ÿæˆã•ã‚Œã‚‹é™çš„ãƒ‘ã‚¹ä¸€è¦§:');
    staticPaths.forEach((path, index) => {
      console.log(`  ${index + 1}. /news/${path.params.slug} (ID: ${path.props.news.id}, Title: ${path.props.news.title})`);
    });

    console.log(`âœ¨ åˆè¨ˆ${staticPaths.length}å€‹ã®é™çš„ãƒ‘ã‚¹ã‚’ç”Ÿæˆå®Œäº†`);
    return staticPaths;

  } catch (error) {
    console.error('ğŸ’¥ åé›†ã«å¤±æ•—:', error);

    // ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªã„å ´åˆã¯ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¦ãƒ“ãƒ«ãƒ‰ã‚’ç¶™ç¶š
    console.log('ğŸš¨ ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‹ãƒ¥ãƒ¼ã‚¹APIã‚‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIã‚‚åˆ©ç”¨ä¸å¯');
    return [
      {
        params: { slug: 'fallback-news' },
        props: {
          news: {
            id: 1,
            slug: 'fallback-news',
            title: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ä¸­...',
            date: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
            category: 'NEWS',
            pic: '/common/images/news/default.png',
            acfs: {},
            content: '<p>ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>',
            link: '',
            article: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...',
            sourceType: 'fallback'
          }
        }
      }
    ];
  }
}

const { news } = Astro.props;
const { slug } = Astro.params;

console.log('ğŸ¯ ç¾åœ¨ã®è©³ç´°ã‚’æ¤œè¨¼:');
console.log(`   Slug: "${slug}"`);
console.log(`   News ID: ${news?.id}`);
console.log(`   News Slug: ${news?.slug}`);
console.log(`   ã‚¿ã‚¤ãƒˆãƒ«: "${news?.title}"`);
console.log(`   ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: ${news?.sourceType || 'unknown'}`);

// ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®å ´åˆã®ç·Šæ€¥å¯¾ç­–
if (!news?.title || news.title === 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—') {
  console.error('ğŸš¨ ã‚¿ã‚¤ãƒˆãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼');
  console.log('Available news props:', Object.keys(news || {}));
}

const pageMeta = {
  title: `${news?.title || 'ãƒ‹ãƒ¥ãƒ¼ã‚¹è©³ç´°'} | News`,
  description: news.excerpt ? news.excerpt.replace(/<[^>]*>/g, '').substring(0, 160) : `${news.title}ã®è©³ç´°ãƒšãƒ¼ã‚¸ã§ã™ã€‚`,
  ogImage: news.pic !== '/common/images/news/default.png' ? news.pic : null,
  ogType: 'article',
  publishedTime: news.lastModified,
  modifiedTime: news.lastModified
};
---

<Layout
  title={news?.title || 'ãƒ‹ãƒ¥ãƒ¼ã‚¹è©³ç´°'}
  pageName="news-detail"
  meta={pageMeta}
>

<!-- é–‹ç™ºæ™‚è©³ç´°è¡¨ç¤ºãƒ‘ãƒãƒ« -->
{import.meta.env.DEV && (
  <div style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.95); color: #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-size: 11px; z-index: 9999; border-radius: 8px; max-width: 350px; border: 1px solid #00ff00;">
    <div style="color: #ffff00; margin-bottom: 8px;">ğŸ” News Detail Panel (Slug-based)</div>
    <div>News ID: {news.id}</div>
    <div>Slug: "{slug}"</div>
    <div>News Slug: {news.slug}</div>
    <div>Title: {news.title?.substring(0, 25)}...</div>
    <div>Category: {news.category}</div>
    <div>Date: {news.date}</div>
    <div style="color: #00ff00; margin-top: 5px;">âœ… Slug-based News API</div>
  </div>
)}

<Article news={news} />
<Related currentSlug={news.slug} />

<script define:vars={{ news, slug }}>
  console.log(`ğŸ“‹ Slug: "${slug}"`);
  console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿:', news);

  window.newsData = news;
  window.NewsArticle = news;
  window.currentSlug = slug;
  window.routingMode = 'SLUG_BASED_NEWS';

  // URLæ¤œè¨¼
  const currentPath = window.location.pathname;
  const expectedPath = `/news/${slug}`;

  console.log(`ğŸ”— ç¾åœ¨ä½ç½®: ${currentPath}`);
  console.log(`ğŸ¯ äºˆæƒ³ä½ç½®: ${expectedPath}`);

  if (currentPath === expectedPath) {
    console.log('âœ… ã‚¹ãƒ©ãƒƒã‚°ãƒ™ãƒ¼ã‚¹ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§æ­£å¸¸å‹•ä½œ');
  } else {
    console.warn('âš ï¸ ä½ç½®æƒ…å ±ã«çŸ›ç›¾ã‚ã‚Š - è¿½åŠ èª¿æŸ»ãŒå¿…è¦');
  }
</script>

</Layout>

<style lang="scss" is:global>
@use '../../assets/scss/mediaquery' as me;
@use '../../assets/scss/mixin' as mi;

// ã‚¯ãƒªãƒ¼ãƒ³ãªå¤šè¨€èªå¯¾å¿œ
.news-detail {
  transition: opacity 0.3s ease;

  &.loading {
    opacity: 0.7;
  }

  // æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã®æœ€é©åŒ–
  &[lang="ja"] {
    font-family: 'Noto Sans JP', sans-serif;
  }
}
</style>
