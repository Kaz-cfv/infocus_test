---
import Layout from '../../layouts/Layout.astro';
import Article from '../../components/news-detail/section/Article.astro';
import Related from '../../components/news-detail/section/Related.astro';

export async function getStaticPaths() {
  try {
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
    let projects = [];

    try {
      console.log(':satellite_antenna: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
      const projectResponse = await fetch('https://infocus.wp.site-prev2.com/wp-json/wp/v2/projects', {
        headers: {
          'User-Agent': 'Astro-Build/1.0.0',
          'Accept': 'application/json',
          'Cache-Control': 'no-cache'
        }
      });

      // è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å–å¾—
      if (!projectResponse.ok) {
        const errorText = await projectResponse.text();
        console.log(`:warning: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIæ¥ç¶šå¤±æ•—: ${projectResponse.status}`);
        console.log(`:clipboard: ã‚¨ãƒ©ãƒ¼è©³ç´°: ${errorText}`);
        console.log(`:link: Response headers:`, Object.fromEntries(projectResponse.headers.entries()));

        // JSONã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è©¦è¡Œ
        try {
          const errorJson = JSON.parse(errorText);
          console.log(`:boom: ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${errorJson.code || 'unknown'}`);
          console.log(`:speech_balloon: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${errorJson.message || 'no message'}`);
        } catch (parseError) {
          console.log(`:page_facing_up: Raw response: ${errorText}`);
        }
        return;
      }

      projects = await projectResponse.json();
      console.log(`:white_check_mark: ${projects.length}ä»¶ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—`);
    } catch (projectError) {
      console.log(':information_source: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIæ¥ç¶šã‚¨ãƒ©ãƒ¼:', projectError.message);
      console.log(':mag: Stack trace:', projectError.stack);
    }

    // æ—¥æœ¬èªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãã§ãƒ‹ãƒ¥ãƒ¼ã‚¹APIã‹ã‚‰åé›†
    let newsData = [];

    try {
      console.log('ğŸ“¡ ãƒ‹ãƒ¥ãƒ¼ã‚¹APIï¼ˆæ—¥æœ¬èªï¼‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
      const newsResponse = await fetch('https://infocus.wp.site-prev2.com/wp-json/wp/v2/news?lang=ja&_embed', {
        headers: {
          'User-Agent': 'Astro-Build/1.0.0',
          'Accept': 'application/json',
          'Cache-Control': 'no-cache'
        }
      });

      if (newsResponse.ok) {
        const wpNews = await newsResponse.json();
        console.log(`âœ… ${wpNews.length}ä»¶ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾—`);

        // ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆçš„ã«å‡¦ç†
        const processedNews = wpNews.map((item, index) => {
          const formatDate = (dateString) => {
            try {
              const date = new Date(dateString);
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              return `${year}.${month}.${day}`;
            } catch (error) {
              console.warn('âš ï¸ æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', dateString);
              return '----.--.--';
            }
          };

          const getThumbnail = (item) => {
            if (item.acfs?.news_mv?.url) {
              return item.acfs.news_mv.url;
            }
            if (item.acfs?.news_mv?.sizes?.large) {
              return item.acfs.news_mv.sizes.large;
            }
            if (item.featured_media && item._embedded?.['wp:featuredmedia']?.[0]?.source_url) {
              return item._embedded['wp:featuredmedia'][0].source_url;
            }
            return '/common/images/news/default.png';
          };

          const slug = item.slug;

          // ã‚¿ã‚¤ãƒˆãƒ«ã®æ§˜ã€…ãªå½¢å¼ã«å¯¾å¿œ
          let title = 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—';
          if (typeof item.title === 'string') {
            title = item.title;
          } else if (item.title?.rendered) {
            title = item.title.rendered;
          } else if (item.title_plain) {
            title = item.title_plain;
          } else if (item.acfs?.news_title) {
            title = item.acfs.news_title;
          }

          console.log(`ğŸ” ãƒ‹ãƒ¥ãƒ¼ã‚¹${index + 1}: ID=${item.id}, slug="${slug}"`);
          console.log(`   ã‚¿ã‚¤ãƒˆãƒ«å–å¾—çµæœ: "${title}"`);
          console.log(`   å…ƒãƒ‡ãƒ¼ã‚¿æ§‹é€ : ${typeof item.title}, rendered: ${item.title?.rendered}`);

          return {
            id: item.id,
            slug: slug,
            title: title,
            date: formatDate(item.date),
            category: item.type?.toUpperCase() || 'NEWS',
            pic: getThumbnail(item),
            acfs: item.acfs || {},
            content: item.content?.rendered || '',
            link: item.link || '',
            article: item.acfs?.news_article || '',
            excerpt: item.excerpt?.rendered || '',
            // ãƒ‹ãƒ¥ãƒ¼ã‚¹å›ºæœ‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            tags: item.acfs?.news_tags || [],
            author: item.acfs?.news_author || '',
            wordpressId: item.id,
            lastModified: item.modified || item.date,
            sourceType: 'news'
          };
        });

        newsData.push(...processedNews);

      } else {
        console.log('âš ï¸ ãƒ‹ãƒ¥ãƒ¼ã‚¹APIï¼ˆæ—¥æœ¬èªï¼‰ãŒåˆ©ç”¨ä¸å¯');
      }
    } catch (newsError) {
      console.log('â„¹ï¸ ãƒ‹ãƒ¥ãƒ¼ã‚¹APIæ¥ç¶šã‚¨ãƒ©ãƒ¼:', newsError.message);
    }

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚‚è£œå®Œã¨ã—ã¦è¿½åŠ ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
    const processedProjects = projects.length > 0 ? projects.map((project, index) => {
      const formatDate = (dateString) => {
        try {
          const date = new Date(dateString);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}.${month}.${day}`;
        } catch (error) {
          return '----.--.--';
        }
      };

      const getThumbnail = (item) => {
        if (item.acfs?.project_mv?.url) {
          return item.acfs.project_mv.url;
        }
        return '/common/images/news/default.png';
      };

      const getCategory = (item) => {
        if (item.class_list && Array.isArray(item.class_list)) {
          const categoryClass = item.class_list.find(cls => cls.startsWith('projects-'));
          if (categoryClass) {
            return categoryClass.replace('projects-', '').replace('-', ' ').toUpperCase();
          }
        }
        return 'PROJECT';
      };

      console.log(`ğŸ” ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ${index + 1}: ID=${project.id}, slug="${project.slug}"`);

      return {
        id: project.id,
        slug: project.slug,
        title: project.title?.rendered || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—',
        date: formatDate(project.date),
        category: getCategory(project),
        pic: getThumbnail(project),
        acfs: project.acfs || {},
        content: project.content?.rendered || '',
        link: project.link || '',
        article: project.acfs?.project_outline || '',
        outline: project.acfs?.project_outline || '',
        credits: project.acfs?.project_credits || '',
        sourceType: 'project'
      };
    }) : [];

    // ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
    if (newsData.length === 0 && processedProjects.length > 0) {
      console.log('â„¹ï¸ ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
      newsData.push(...processedProjects);
    }

    const staticPaths = newsData.map((news) => ({
      params: { id: news.id.toString() },
      props: { news }
    }));

    console.log('ğŸ›¤ï¸ ç”Ÿæˆã•ã‚Œã‚‹é™çš„ãƒ‘ã‚¹ä¸€è¦§:');
    staticPaths.forEach((path, index) => {
      console.log(`  ${index + 1}. /news/${path.params.id} (ID: ${path.props.news.id}, Source: ${path.props.news.sourceType})`);
    });

    console.log(`âœ¨ åˆè¨ˆ${staticPaths.length}å€‹ã®é™çš„ãƒ‘ã‚¹ã‚’ç”Ÿæˆå®Œäº†`);
    return staticPaths;

  } catch (error) {
    console.error('ğŸ’¥ åé›†ã«å¤±æ•—:', error);

    // ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªã„å ´åˆã¯ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¦ãƒ“ãƒ«ãƒ‰ã‚’ç¶™ç¶š
    console.log('ğŸš¨ ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‹ãƒ¥ãƒ¼ã‚¹APIã‚‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIã‚‚åˆ©ç”¨ä¸å¯');
    return [
      {
        params: { id: '1' },
        props: {
          news: {
            id: 1,
            slug: 'fallback-news',
            title: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ä¸­...',
            date: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
            category: 'NEWS',
            pic: '/common/images/news/default.png',
            acfs: {},
            content: '<p>ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>',
            link: '',
            article: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...',
            sourceType: 'fallback'
          }
        }
      }
    ];
  }
}

const { news } = Astro.props;
const { id } = Astro.params;

console.log('ğŸ¯ ç¾åœ¨ã®è¨¼æ‹ ã‚’æ¤œè¨¼:');
console.log(`   ID: "${id}"`);
console.log(`   News ID: ${news?.id}`);
console.log(`   ã‚¿ã‚¤ãƒˆãƒ«: "${news?.title}"`);
console.log(`   ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: ${news?.sourceType || 'unknown'}`);

// ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®å ´åˆã®ç·Šæ€¥å¯¾ç­–
if (!news?.title || news.title === 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—') {
  console.error('ğŸš¨ ã‚¿ã‚¤ãƒˆãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼');
  console.log('Available news props:', Object.keys(news || {}));
}

const pageMeta = {
  title: `${news?.title || 'ãƒ‹ãƒ¥ãƒ¼ã‚¹è©³ç´°'} | News`,
  description: news.excerpt ? news.excerpt.replace(/<[^>]*>/g, '').substring(0, 160) : `${news.title}ã®è©³ç´°ãƒšãƒ¼ã‚¸ã§ã™ã€‚`,
  ogImage: news.pic !== '/common/images/news/default.png' ? news.pic : null,
  ogType: 'article',
  publishedTime: news.lastModified,
  modifiedTime: news.lastModified
};
---

<Layout
  title={news?.title || 'ãƒ‹ãƒ¥ãƒ¼ã‚¹è©³ç´°'}
  pageName="news-detail"
  meta={pageMeta}
>

<!-- é–‹ç™ºæ™‚è¨¼æ‹ è¡¨ç¤ºãƒ‘ãƒãƒ« -->
{import.meta.env.DEV && (
  <div style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.95); color: #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-size: 11px; z-index: 9999; border-radius: 8px; max-width: 350px; border: 1px solid #00ff00;">
    <div style="color: #ffff00; margin-bottom: 8px;">ğŸ” Detective Panel (SSG + Lang)</div>
    <div>Case ID: {news.id}</div>
    <div>ID: "{id}"</div>
    <div>Title: {news.title?.substring(0, 25)}...</div>
    <div>Category: {news.category}</div>
    <div>Date: {news.date}</div>
    <div>Source: {news.sourceType}</div>
    <div style="color: #00ff00; margin-top: 5px;">âœ… SSG + Japanese API</div>
  </div>
)}

<Article news={news} />
<Related currentId={news.id} />

<script define:vars={{ news, id }}>
  console.log(`ğŸ“‹ ID: "${id}"`);
  console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿:', news);

  window.newsData = news;
  window.NewsArticle = news;
  window.currentId = id;
  window.investigationMode = 'SSG_MULTILANG';

  // URLæ¤œè¨¼
  const currentPath = window.location.pathname;
  const expectedPath = `/news/${id}`;

  console.log(`ğŸ”— ç¾åœ¨ä½ç½®: ${currentPath}`);
  console.log(`ğŸ¯ äºˆæƒ³ä½ç½®: ${expectedPath}`);

  if (currentPath === expectedPath) {
    console.log('âœ… IDãƒ™ãƒ¼ã‚¹SSGãƒ¢ãƒ¼ãƒ‰ã§æ­£å¸¸å‹•ä½œ');
  } else {
    console.warn('âš ï¸ ä½ç½®æƒ…å ±ã«çŸ›ç›¾ã‚ã‚Š - è¿½åŠ èª¿æŸ»ãŒå¿…è¦');
  }
</script>

</Layout>

<style lang="scss" is:global>
@use '../../assets/scss/mediaquery' as me;
@use '../../assets/scss/mixin' as mi;

// ã‚¯ãƒªãƒ¼ãƒ³ãªå¤šè¨€èªå¯¾å¿œ
.news-detail {
  transition: opacity 0.3s ease;

  &.loading {
    opacity: 0.7;
  }

  // æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã®æœ€é©åŒ–
  &[lang="ja"] {
    font-family: 'Noto Sans JP', sans-serif;
  }
}
</style>
