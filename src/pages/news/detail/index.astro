---
import Layout from '../../../layouts/Layout.astro';
import Content from '../../../components/news-detail/parts/Content.astro';
import Credit from '../../../components/news-detail/section/Credit.astro';
import Share from '../../../components/news-detail/parts/Share.astro';
import Related from '../../../components/news-detail/section/Related.astro';

// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‹ã‚‰idã‚’å–å¾—
const url = Astro.url;
const id = url.searchParams.get('id');

console.log('ğŸ” URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼å–å¾—:', {
  fullUrl: url.toString(),
  id: id,
  searchParams: Object.fromEntries(url.searchParams.entries())
});

let article: any = null;

// idãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯APIã‹ã‚‰è¨˜äº‹ã‚’å–å¾—
if (id) {
  try {
    console.log(`ğŸ“¡ è¨˜äº‹ID: ${id} ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...`);

    // ãƒ‹ãƒ¥ãƒ¼ã‚¹APIã‹ã‚‰è¨˜äº‹è©³ç´°ã‚’å–å¾—
    const newsUrl = `https://infocus.wp.site-prev2.com/wp-json/wp/v2/news/${id}`;
    console.log(`ğŸ”— ãƒ‹ãƒ¥ãƒ¼ã‚¹API URL: ${newsUrl}`);
    
    const newsResponse = await fetch(newsUrl, {
      headers: {
        'User-Agent': 'Astro-Build/1.0.0',
        'Accept': 'application/json',
        'Cache-Control': 'no-cache'
      }
    });

    console.log(`ğŸ“Š ãƒ‹ãƒ¥ãƒ¼ã‚¹APIãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${newsResponse.status} ${newsResponse.statusText}`);

    if (newsResponse.ok) {
      const newsData: any = await newsResponse.json();
      console.log('âœ… ãƒ‹ãƒ¥ãƒ¼ã‚¹APIã‹ã‚‰è¨˜äº‹å–å¾—æˆåŠŸ:', newsData);

      // ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜äº‹å½¢å¼ã«å¤‰æ›
      article = {
        id: newsData.id,
        slug: newsData.slug || `news-${newsData.id}`,
        title: newsData.title?.rendered || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—',
        date: new Date(newsData.date).toISOString().split('T')[0].replace(/-/g, '.'),
        category: 'NEWS',
        pic: newsData.acfs?.news_mv?.url || '/common/images/news/default.png',
        content: newsData.content?.rendered || '',
        article: newsData.acfs?.news_article || '',
        credit: []
      };
    } else {
      console.log(`âš ï¸ ãƒ‹ãƒ¥ãƒ¼ã‚¹APIå¤±æ•— (${newsResponse.status}), ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIã‚’è©¦è¡Œ...`);

      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIã‹ã‚‰è¨˜äº‹è©³ç´°ã‚’å–å¾—
      const projectUrl = `https://infocus.wp.site-prev2.com/wp-json/wp/v2/projects/${id}`;
      console.log(`ğŸ”— ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPI URL: ${projectUrl}`);
      
      const projectResponse = await fetch(projectUrl, {
        headers: {
          'User-Agent': 'Astro-Build/1.0.0',
          'Accept': 'application/json',
          'Cache-Control': 'no-cache'
        }
      });

      console.log(`ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${projectResponse.status} ${projectResponse.statusText}`);

      if (projectResponse.ok) {
        const projectData: any = await projectResponse.json();
        console.log('âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIã‹ã‚‰è¨˜äº‹å–å¾—æˆåŠŸ:', projectData);

        article = {
          id: projectData.id,
          slug: projectData.slug || `project-${projectData.id}`,
          title: projectData.title?.rendered || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—',
          date: new Date(projectData.date).toISOString().split('T')[0].replace(/-/g, '.'),
          category: 'PROJECT',
          pic: projectData.acfs?.project_mv?.url || '/common/images/news/default.png',
          content: projectData.content?.rendered || '',
          article: projectData.acfs?.project_outline || '',
          credit: []
        };
      } else {
        console.log(`âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIã‚‚å¤±æ•— (${projectResponse.status})`);
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚‚ç¢ºèª
        try {
          const errorText = await projectResponse.text();
          console.log('âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIã‚¨ãƒ©ãƒ¼è©³ç´°:', errorText.substring(0, 200));
        } catch (e) {
          console.log('âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIã‚¨ãƒ©ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆå–å¾—å¤±æ•—');
        }
      }
    }
  } catch (error) {
    console.error('ğŸ’¥ è¨˜äº‹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
if (!article) {
  console.log('ğŸš¨ APIã‹ã‚‰è¨˜äº‹ãŒå–å¾—ã§ããªã„ãŸã‚ã€ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
  article = {
    id: 'fallback',
    slug: 'detail01',
    title: 'CHELMICO éˆ´æœ¨çœŸæµ·å­ãŒå‡ºæ¼”ã™ã‚‹ã€æ•£æ–‡ã®è¨˜æ†¶ | è¡—ãƒ»è¨€è‘‰ãƒ»æ™‚ã€…é…’ BY MUDAã€ãŒYouTubeã«ã¦å…¬é–‹',
    date: '2025.03.31',
    category: 'Project',
    pic: '/common/images/dummy/news_detail_eyecatch.png',
    credit: [
      {
        title: 'movie',
        items: [
          {
            caption: 'DIRECTION',
            content: 'Taiju Nakajima (IN FOCUS)',
            link: true,
            url: '/team/detail/',
          },
          {
            caption: 'OFFLINE EDIT',
            content: 'Miho Tanaka (IN FOCUS)',
            link: true,
            url: '/team/detail/',
          },
          {
            caption: 'MOTION GRAPHICS',
            content: 'Miho Tanaka (IN FOCUS)',
            link: true,
            url: '/team/detail/',
          },
          {
            caption: 'GRAPHIC DESIGN',
            content: 'Anna Senzaki (IN FOCUS)',
            link: true,
            url: '/team/detail/',
          },
          {
            caption: 'CINEMATOGRAPHY',
            content: 'Yoshinori Kataoka (IN FOCUS)',
            link: true,
            url: '/team/detail/',
          },
          {
            caption: 'MUSIC',
            content: 'Yudai Iwata',
            link: false,
            url: '',
          },
          {
            caption: 'SOUND EFFECT',
            content: 'Fumio Yasue',
            link: false,
            url: '',
          },
          {
            caption: 'NARRATION',
            content: 'Ayana Shimizu',
            link: false,
            url: '',
          },
        ],
      },
      {
        title: 'Web site',
        items: [
          {
            caption: 'CREATIVE DIRECTION',
            content: 'Atsushi Kaneishi (IN FOCUS)',
            link: true,
            url: '/team/detail/',
          },
          {
            caption: 'WEB DIRECTION',
            content: 'Atsushi Kaneishi (IN FOCUS)',
            link: true,
            url: '/team/detail/',
          },
          {
            caption: 'WEB DESIGN',
            content: 'Miho Nagatsuka (IN FOCUS)',
            link: true,
            url: '/team/detail/',
          },
          {
            caption: 'PROGRAMMING',
            content: 'Yuta Abe (IN FOCUS)',
            link: true,
            url: '/team/detail/',
          },
        ],
      },
      {
        title: '3DCG',
        items: [
          {
            caption: 'ART DIRECTION',
            content: 'Atsushi Kaneishi (IN FOCUS)',
            link: true,
            url: '/team/detail/',
          },
          {
            caption: 'CG PRODUCTION',
            content: 'KASSEN',
            link: false,
            url: '',
          },
        ],
      },
      {
        title: '',
        items: [
          {
            caption: 'PRODUCE',
            content: 'Kazuki Sekiyama (IN FOCUS)',
            link: true,
            url: '/team/detail/',
          },
          {
            caption: 'PRODUCTION MANAGEMENT',
            content: 'Tomoyuki Ishizaki (IN FOCUS)',
            link: true,
            url: '/team/detail/',
          },
        ],
      },
    ],
  };
}

const pageMeta = {
  title: "NEWS DETAIL",
};
---

<Layout
  title=""
  pageName="news-detail"
  meta={pageMeta}
>

<article class="p-news-detial-article">
  <div class="p-news-detial-article__pic">
    <figure>
      <img src={article.pic} alt={article.title}>
    </figure>
  </div>

  <section class="p-news-detial-article__about">
    <h1 class="p-news-detial-article__about-title">{article.title}</h1>
    <div class="p-news-detial-article__about-info">
      <time class="p-news-detial-article__about-date">{article.date}</time>
      <span class="p-news-detial-article__about-category">{article.category}</span>
    </div>
  </section>

  <section class="p-news-detial-article__content">
    <div class="c-article">
      <p>
        ã€Œã‚‚ã£ã¨æ°—è»½ã«ã‚‚ã£ã¨æ¥½ã—ãã‚´ãƒ«ãƒ•ã‚’ã—ã‚ˆã†ã€ã¨ã„ã†ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®ã‚‚ã¨ã€ã‚ã‚‰ã‚†ã‚‹æ çµ„ã¿ã‚’è¶…ãˆãŸæ–°ã—ã„ã‚´ãƒ«ãƒ•ã‚¦ã‚§ã‚¢ã‚’ææ¡ˆã—ã¦ã„ã‚‹PEARLY GATESã‹ã‚‰2025 SPRING COLLECTIONãŒãƒ­ãƒ¼ãƒ³ãƒã€‚ãƒ¢ãƒ‡ãƒ«ãƒ»å¥³å„ªã¨ã—ã¦æ´»èºã™ã‚‹äº•æ¡å¼˜æµã•ã‚“ã‚’èµ·ç”¨ã—ã€ä»Šå›ã®æ–°ä½œã‚’æ‰‹ã«å–ã£ã¦ã‚‚ã‚‰ã„ã€ä½“é¨“ã™ã‚‹æ˜ åƒã‚’åˆ¶ä½œã—ã¾ã—ãŸã€‚<br>
        ã€ŒPG SMILEã€ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚„ã€ã‚«ãƒ©ãƒ¼ã‚·ãƒ¥ãƒ¼ã‚ºã«å‡ºä¼šã£ãŸã¨ãã®ã€Œã‚«ãƒ¯ã‚¤ã‚¤ã€è¡¨æƒ…ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã€æ˜¥ã‚‰ã—ã„æ–°é®®ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã«ä»•ä¸Šã’ã¦ã„ã¾ã™ã€‚
      </p>
      <!-- <p>
        muda Youtube<br>
        <a href="https://www.youtube.com/@muda-media" target="_blank">https://www.youtube.com/@muda-media</a><br>
        muda Instagram<br>
        <a href="https://www.instagram.com/muda_media_jp/" target="_blank">https://www.instagram.com/muda_media_jp/</a><br>
        muda X<br>
        <a href="https://x.com/muda_mediajp" target="_blank">https://x.com/muda_mediajp</a><br>
        muda TikTok<br>
        <a href="https://www.tiktok.com/@muda_media" target="_blank">https://www.tiktok.com/@muda_media</a><br>
        muda official site<br>
        <a href="https://muda-media.com/" target="_blank">https://muda-media.com/</a>
      </p> -->
      <p>
        <figure>
          <img src="/common/images/dummy/news_detail_01.png" alt="">
        </figure>
        <figure>
          <img src="/common/images/dummy/news_detail_02.png" alt="">
        </figure>
        <figure>
          <img src="/common/images/dummy/news_detail_03.png" alt="">
        </figure>
        <figure>
          <img src="/common/images/dummy/news_detail_04.png" alt="">
        </figure>
      </p>
    </div>
    <Credit creditData={article.credit} />
  </section>

  <Share
    slug={article.slug}
  />
</article>
<Related />

<script define:vars={{ article, id }}>
  // windowå¤‰æ•°ã«NewsArticleã¨ã—ã¦è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
  window.NewsArticle = article;
  
  console.log('ğŸ’¾ NewsArticleã‚’windowå¤‰æ•°ã«ä¿å­˜:', window.NewsArticle);
  console.log(`ğŸ“ è¨˜äº‹ID: ${id || 'ãªã—'}`);
  console.log(`ğŸ“° è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«: ${article.title}`);
  console.log(`ğŸ“… è¨˜äº‹æ—¥ä»˜: ${article.date}`);
  console.log(`ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª: ${article.category}`);
  
  // ãƒ‡ãƒãƒƒã‚°ç”¨ã®è¿½åŠ æƒ…å ±
  console.log('ğŸ” è¨˜äº‹ã®å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ :');
  console.table({
    ID: article.id,
    Slug: article.slug,
    Title: article.title?.substring(0, 50) + '...',
    Date: article.date,
    Category: article.category,
    HasPic: !!article.pic,
    HasContent: !!article.content,
    HasArticle: !!article.article,
    CreditSections: article.credit?.length || 0
  });
</script>

</Layout>

<style lang="scss">
@use '../../../assets/scss/mediaquery' as me;
@use '../../../assets/scss/mixin' as mi;

.p-news-detial-article {
  margin-block-start: 50px;
  @include me.sp {
    margin-block-start: 24px;
    padding-inline: 20px;
  }

  &__pic {
    @include me.pc {
      margin-inline: 148px;
    }
  }

  &__about {
    margin-block-start: 50px;
    @include me.pc {
      max-width: 910px;
      margin-inline: auto;
    }
    @include me.sp {
      margin-block-start: 24px;
    }

    &-title {
      font-size: 2.2rem;
      line-height: 1.5;
      @include me.sp {
        font-size: 1.6rem;
      }
    }

    &-info {
      display: flex;
      align-items: center;
      column-gap: 4px;
      margin-block-start: 22px;
      color: var(--c-gray);
      font-size: 1.6rem;
      font-weight: 500;
      @include me.sp {
        margin-block-start: 16px;
        font-size: 1.4rem;
      }
    }

    &-date {
      display: flex;
      align-items: center;
      column-gap: 4px;
      &::after {
        content: "-";
        display: inline-block;
      }
    }

  }

  &__content {
    margin-block-start: 50px;
    @include me.pc {
      max-width: 910px;
      margin-inline: auto;
    }
    @include me.sp {
      margin-block-start: 40px;
    }
  }
}

.c-article {
  font-family: var(--f-jp);
  font-size: 1.6rem;
  line-height: 1.7;
  @include me.sp {
    font-size: 1.4rem;
    line-height: 1.6;
  }

  h2 {
    margin-block-end: 12px;
    font-size: 1.8rem;
    @include me.sp {
      font-size: 1.7rem;
    }
  }

  h3 {
    margin-block-end: 12px;
    font-size: 1.5rem;
    @include me.sp {
      font-size: 1.4rem;
    }
  }

  h4,
  h5,
  h6 {
    font-size: 1.4rem;
    margin-block-end: 12px;
    font-weight: 400;
    line-height: 1.8;
  }

  p {
    margin-block-end: 50px;
    font-size: 1.4rem;
    line-height: 1.8;
  }

  a {
    display: inline-block;
    position: relative;
    margin-block-end: 4px;
    color: var(--c-white);
    @include me.pc {
      &::after {
        content: "";
        position: absolute;
        bottom: 2px;
        left: 0;
        width: 100%;
        height: 1px;
        background-color: var(--c-white);
      }
    }
    @include me.sp {
      text-decoration: underline;
    }
  }

  em,
  i {
    font-style: italic;
  }

  u {
    position: relative;
    text-decoration: none;
    &::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 1px;
      background-color: var(--c-white);
    }
  }

  figure {
    margin-block-end: 30px;
  }

  figcaption {
    display: inline-block;
    margin-block-start: 20px;
    font-size: 1.2rem;
    line-height: 1.7;
    @include me.sp {
      margin-block-start: 10px;
    }
  }
}
</style>
