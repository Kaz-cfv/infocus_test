---
import Layout from '@layouts/LayoutEn.astro';
import Article from '@components/projects-detail/section/Article.astro';
import Related from '@components/projects-detail/section/Related.astro';

const lang = 'en';

export async function getStaticPaths() {
  try {
    let allProjects = [];
    let currentPage = 1;
    let hasMorePages = true;

    while (hasMorePages) {
      const response = await fetch(
        `https://infocus.wp.site-prev2.com/api/rest/?path=wp/v2/projects&lang=en&per_page=100&page=${currentPage}`
      );

      if (!response.ok) {
        console.error(`âŒ ãƒšãƒ¼ã‚¸${currentPage}ã§APIã‚¨ãƒ©ãƒ¼:`, response.status);
        break;
      }

      const pageData = JSON.parse(await response.text());
      const pageArray = Array.isArray(pageData) ? pageData : [pageData];

      // console.log(`ğŸ“Š ãƒšãƒ¼ã‚¸${currentPage}ã§å–å¾—: ${pageArray.length}ä»¶`);

      if (pageArray.length === 0) {
        hasMorePages = false;
      } else {
        allProjects = [...allProjects, ...pageArray];

        if (pageArray.length < 100) {
          hasMorePages = false;
        } else {
          currentPage++;
        }
      }

      if (currentPage > 10) {
        console.warn('âš ï¸ ãƒšãƒ¼ã‚¸æ•°ä¸Šé™ã«é”ã—ã¾ã—ãŸ');
        break;
      }
    }

    // console.log('ğŸ“Š å…¨ä½“ã§å–å¾—ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°:', allProjects.length);

    // æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const validProjects = allProjects.filter(item => {
      const hasTitle = item.title && (typeof item.title === 'string' ? item.title.trim() : item.title.rendered);
      const hasSlug = item.slug;
      return hasTitle && hasSlug;
    });

    // console.log('âœ… æœ‰åŠ¹ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°:', validProjects.length);

    return validProjects.map((project) => ({
      params: { slug: project.slug },
      props: { project, allProjects: validProjects } // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚‚æ¸¡ã™
    }));

  } catch (error) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:', error);
    return [];
  }
}

const { project, allProjects } = Astro.props;

// å‰å¾Œã®è¨˜äº‹ã‚’å–å¾—
let prevProject = null;
let nextProject = null;

try {
  // æ—¥ä»˜é †ã§ã‚½ãƒ¼ãƒˆï¼ˆé™é † = æ–°ã—ã„é †ï¼‰
  const sortedProjects = [...allProjects].sort((a, b) => new Date(b.date) - new Date(a.date));

  // ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®š
  const currentIndex = sortedProjects.findIndex(p => p.slug === project.slug);

  // console.log('ğŸ¯ ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:', project.slug, 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', currentIndex);

  if (currentIndex !== -1) {
    // å‰ã®è¨˜äº‹ï¼ˆã‚ˆã‚Šæ–°ã—ã„è¨˜äº‹ï¼‰
    if (currentIndex > 0) {
      const prev = sortedProjects[currentIndex - 1];
      prevProject = {
        slug: prev.slug,
        title: typeof prev.title === 'string' ? prev.title : prev.title.rendered
      };
    }

    // æ¬¡ã®è¨˜äº‹ï¼ˆã‚ˆã‚Šå¤ã„è¨˜äº‹ï¼‰
    if (currentIndex < sortedProjects.length - 1) {
      const next = sortedProjects[currentIndex + 1];
      nextProject = {
        slug: next.slug,
        title: typeof next.title === 'string' ? next.title : next.title.rendered
      };
    }
  }
} catch (error) {
  console.error('âŒ å‰å¾Œè¨˜äº‹ã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼:', error);
}

// é–¢é€£ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é™¤å¤–ï¼‰
const relatedProjects = allProjects
  .filter(item => item.slug !== project.slug)
  .map((item, index) => {
    // æ–°ã—ã„APIæ§‹é€ ã«åˆã‚ã›ã¦ã‚¿ã‚°ã‚’æŠ½å‡º
    let tags = [];

    if (item.taxonomy?.projects && Array.isArray(item.taxonomy.projects)) {
      tags = item.taxonomy.projects.map(tag => ({
        name: tag.name,
        url: `/projects/?category=${tag.slug || tag.term_id || ''}`
      }));
    }

    // æ–°ã—ã„APIæ§‹é€ ã«åˆã‚ã›ã¦ç”»åƒã‚’æŠ½å‡º
    const acfsData = item.acfs || item.acf;
    const imageSrc = acfsData?.main?.image?.url || acfsData?.thumbnail?.image?.url;

    // console.log('ğŸ” é–¢é€£ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‡¦ç†:', {
    //   slug: item.slug,
    //   tagsCount: tags.length,
    //   hasImage: !!imageSrc,
    //   imageUrl: imageSrc?.substring(0, 50) + '...'
    // });

    return {
      id: item.id || index + 1,
      title: (typeof item.title === 'string' ? item.title : item.title.rendered).trim(),
      tags: tags,
      imageSrc: imageSrc,
      url: `/projects/${item.slug}/`,
      type: "default"
    };
  })
  .sort((a, b) => b.id - a.id) // IDã®é™é †ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
  .slice(0, 8); // é–¢é€£ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯æœ€å¤§8ä»¶ã¾ã§è¡¨ç¤º

// ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®è¨­å®š
const title = typeof project.title === 'string' ? project.title : project.title.rendered;
const acfData = project.acf || project.acfs;
const description = acfData?.outline ? acfData.outline.replace(/<[^>]*>/g, '').substring(0, 160) : '';

const pageMeta = {
  title: title,
  ogpType: "website"
};
---

<Layout
  title={title}
  pageName="project-detail"
  meta={pageMeta}
>

<Article
  lang={lang}
  project={project}
  prevProject={prevProject}
  nextProject={nextProject}
/>

{relatedProjects.length > 0 && (
  <Related
    lang={lang}
    projects={relatedProjects}
  />
)}

</Layout>

<style lang="scss" is:global>
@use '../../../assets/scss/mediaquery' as me;
@use '../../../assets/scss/mixin' as mi;

</style>
