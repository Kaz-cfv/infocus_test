---
import Layout from '@layouts/LayoutEn.astro';
import Content from '@components/news-detail/parts/Content.astro';
import Credit from '@components/news-detail/section/Credit.astro';
import Share from '@components/news-detail/parts/Share.astro';
import Related from '@components/news-detail/section/Related.astro';

const lang = 'en';

export async function getStaticPaths() {
  // ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  function getCategoryInfo(taxonomyNews) {
    if (!taxonomyNews || !Array.isArray(taxonomyNews) || taxonomyNews.length === 0) {
      return { name: 'News', slug: 'news' }; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    }

    // æœ€åˆã®ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±ã‚’ä½¿ç”¨ï¼ˆé€šå¸¸ã¯1ã¤ã®ã¿ï¼‰
    const category = taxonomyNews[0];

    if (category && category.name && category.slug) {
      return { name: category.name, slug: category.slug };
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    return { name: 'News', slug: 'news' };
  }

  try {
    // Step 1: ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆãƒšãƒ¼ã‚¸ãƒ³ã‚°å¯¾å¿œï¼‰
    let allNewsArticles = [];
    let currentPage = 1;
    let hasMorePages = true;

    while (hasMorePages) {
      const newsResponse = await fetch(
        `https://infocus.wp.site-prev2.com/api/rest/?path=wp/v2/news&lang=en&per_page=50&page=${currentPage}`
      );

      if (!newsResponse.ok) {
        console.error(`âš ï¸ ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸${currentPage}ã§APIã‚¨ãƒ©ãƒ¼:`, newsResponse.status);
        break;
      }

      const pageData = JSON.parse(await newsResponse.text());
      const pageArray = Array.isArray(pageData) ? pageData : [pageData];

      // console.log(`ğŸ“Š ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸${currentPage}ã§å–å¾—: ${pageArray.length}ä»¶`);

      if (pageArray.length === 0) {
        hasMorePages = false;
      } else {
        allNewsArticles = [...allNewsArticles, ...pageArray];

        if (pageArray.length < 50) {
          hasMorePages = false;
        } else {
          currentPage++;
        }
      }

      // å®‰å…¨è£…ç½®ï¼šç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
      if (currentPage > 10) {
        console.warn('âš ï¸ ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãƒšãƒ¼ã‚¸æ•°ä¸Šé™ã«é”ã—ã¾ã—ãŸ');
        break;
      }
    }

    // console.log('ğŸ“Š å…¨ä½“ã§å–å¾—ã—ãŸãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹æ•°:', allNewsArticles.length);

    // Step 2: æœ‰åŠ¹ãªãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const validArticles = allNewsArticles.filter(item => {
      const hasTitle = item.title && (typeof item.title === 'string' ? item.title.trim() : item.title.rendered);
      const hasSlug = item.slug;
      const hasDate = item.date;
      return hasTitle && hasSlug && hasDate;
    });

    // console.log('âœ… æœ‰åŠ¹ãªãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹æ•°:', validArticles.length);

    // Step 3: å„ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã®ãƒ‘ã‚¹ã‚’ç”Ÿæˆ
    return validArticles.map((item) => {
      // ã‚¿ã‚¤ãƒˆãƒ«å‡¦ç†
      const articleTitle = typeof item.title === 'string' ? item.title : item.title.rendered;

      // ACF/ACFSãƒ‡ãƒ¼ã‚¿ã®å–å¾—
      const acfsData = item.acfs || item.acf;

      // ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±ã®å‡¦ç†ï¼ˆæ–°APIã®taxonomyæ§‹é€ ã«å¯¾å¿œï¼‰
      const categoryInfo = getCategoryInfo(item.taxonomy?.news);

      // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå‡¦ç†
      const formattedDate = new Date(item.date).toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      }).replace(/\//g, '.');

      // è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã®æ§‹ç¯‰
      const articleData = {
        id: item.id,
        slug: item.slug,
        title: articleTitle.trim(),
        date: formattedDate,
        category: categoryInfo.name,        // è¡¨ç¤ºç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼å
        categorySlug: categoryInfo.slug,    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨ã‚¹ãƒ©ãƒƒã‚°
        pic: acfsData?.news_eyecatch?.url || acfsData?.news_mv?.url || null,
        content: item.content.rendered || '',
        rawContent: item.content.rendered || ''
      };

      // é–¢é€£è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã®æ§‹ç¯‰ï¼ˆç¾åœ¨ã®è¨˜äº‹ã‚’é™¤ãï¼‰
      const relatedArticles = validArticles
        .filter(newsItem => newsItem.id !== item.id)
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 3)
        .map(relatedItem => {
          const relatedTitle = typeof relatedItem.title === 'string' ? relatedItem.title : relatedItem.title.rendered;
          const relatedAcfsData = relatedItem.acfs || relatedItem.acf;
          const relatedCategoryInfo = getCategoryInfo(relatedItem.taxonomy?.news);

          const relatedFormattedDate = new Date(relatedItem.date).toLocaleDateString('ja-JP', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          }).replace(/\//g, '.');

          return {
            id: relatedItem.id,
            slug: relatedItem.slug,
            title: relatedTitle.trim(),
            date: relatedFormattedDate,
            category: relatedCategoryInfo.name,        // è¡¨ç¤ºç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼å
            categorySlug: relatedCategoryInfo.slug,    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨ã‚¹ãƒ©ãƒƒã‚°
            pic: relatedAcfsData?.news_eyecatch?.url || relatedAcfsData?.news_mv?.url || null,
            url: `/news/${relatedItem.slug}/`
          };
        });

      // console.log('ğŸ“° è¨˜äº‹å‡¦ç†å®Œäº†:', {
      //   slug: item.slug,
      //   title: articleTitle.substring(0, 30) + '...',
      //   hasImage: !!articleData.pic,
      //   relatedCount: relatedArticles.length,
      //   category: categoryInfo.name
      // });

      return {
        params: { slug: item.slug },
        props: {
          article: articleData,
          relatedArticles: relatedArticles
        }
      };
    });

  } catch (error) {
    console.error('âŒ Newsé™çš„ãƒ‘ã‚¹ç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:', error);
    return [];
  }
}

const { article, relatedArticles } = Astro.props;

// ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®è¨­å®š
const title = article.title;
const description = article.content.replace(/<[^>]*>/g, '').substring(0, 150) + '...';

const pageMeta = {
  title: `${title} | NEWS`,
  description: description,
  ogpType: "article"
};
---

<Layout
  title=""
  pageName="news-detail"
  meta={pageMeta}
>

<article class="p-news-detial-article" data-main-content>
  {article.pic && (
    <div class="p-news-detial-article__pic">
      <figure>
        <img src={article.pic} alt={article.title} />
      </figure>
    </div>
  )}

  <section class="p-news-detial-article__about">
    <h1 class="p-news-detial-article__about-title">{article.title}</h1>
    <div class="p-news-detial-article__about-info">
      <time class="p-news-detial-article__about-date">{article.date}</time>
      <span class="p-news-detial-article__about-category">{article.category}</span>
    </div>
  </section>

  {article.content && (
    <section class="p-news-detial-article__content">
      <div class="c-article">
        <div set:html={article.content}></div>
      </div>
    </section>
  )}

  <Share
    slug={article.slug}
  />
</article>

{relatedArticles && relatedArticles.length > 0 && (
  <Related
    lang={lang}
    relatedArticles={relatedArticles}
  />
)}

</Layout>

<style lang="scss" is:global>
@use '../../../assets/scss/mediaquery' as me;
@use '../../../assets/scss/mixin' as mi;

.p-news-detial-article {
  margin-block-start: 50px;
  @include me.sp {
    margin-block-start: 24px;
    padding-inline: 20px;
  }

  &__pic {
    @include me.pc {
      margin-inline: 148px;
    }
  }

  &__about {
    margin-block-start: 50px;
    @include me.pc {
      max-width: 910px;
      margin-inline: auto;
    }
    @include me.sp {
      margin-block-start: 24px;
    }

    &-title {
      font-size: 2.4rem;
      line-height: 1.5;
      @include me.sp {
        font-size: 1.8rem;
      }
    }

    &-info {
      display: flex;
      align-items: center;
      column-gap: 4px;
      margin-block-start: 22px;
      color: var(--c-gray);
      font-size: 1.6rem;
      font-weight: 500;
      @include me.sp {
        margin-block-start: 16px;
        font-size: 1.4rem;
      }
    }

    &-date {
      display: flex;
      align-items: center;
      column-gap: 4px;
      &::after {
        content: "-";
        display: inline-block;
      }
    }

  }

  &__content {
    margin-block-start: 50px;
    @include me.pc {
      max-width: 910px;
      margin-inline: auto;
    }
    @include me.sp {
      margin-block-start: 40px;
    }
  }
}

.c-article {
  font-family: var(--f-jp);
  font-size: 1.6rem;
  line-height: 1.7;
  @include me.sp {
    font-size: 1.4rem;
    line-height: 1.6;
  }

  h2 {
    margin-block-end: 12px;
    font-size: 1.8rem;
    @include me.sp {
      font-size: 1.7rem;
    }
  }

  h3 {
    margin-block-end: 12px;
    font-size: 1.5rem;
    @include me.sp {
      font-size: 1.4rem;
    }
  }

  h4,
  h5,
  h6 {
    font-size: 1.4rem;
    margin-block-end: 12px;
    font-weight: 400;
    line-height: 1.8;
  }

  p {
    margin-block-end: 24px;
    font-size: 1.4rem;
    line-height: 1.8;
  }

  a {
    display: inline-block;
    position: relative;
    margin-block-end: 4px;
    color: var(--c-white);
    @include me.pc {
      &::after {
        content: "";
        position: absolute;
        bottom: 2px;
        left: 0;
        width: 100%;
        height: 1px;
        background-color: var(--c-white);
      }
    }
    @include me.sp {
      text-decoration: underline;
    }
  }

  em,
  i {
    font-style: italic;
  }

  u {
    position: relative;
    text-decoration: none;
    &::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 1px;
      background-color: var(--c-white);
    }
  }

  figure {
    margin-block-end: 30px;
  }

  figcaption {
    display: inline-block;
    margin-block-start: 20px;
    font-size: 1.2rem;
    line-height: 1.7;
    @include me.sp {
      margin-block-start: 10px;
    }
  }
}
</style>
